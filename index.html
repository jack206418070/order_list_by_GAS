<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./sass/main.css" class="css">
    <link rel="stylesheet" href="./index.css" class="css">
    <link href="./fontawesome-free-5.15.3-web/css/all.css" rel="stylesheet">
    <title>惠民訂購網</title>
</head>

<body>
    <div class="container">
        <div class="row l-header align-items-center jy-content-between">
            <div class="col-md-4">
                <h1>惠民蔬果</h1>
            </div>
            <div class="col-md-8">
                <ul class="l-header-menu d-flex flex-wrap jy-content-end">
                    <li><a href="#" class="js-order my-xs">訂購填寫</a></li>
                    <li><a href="#" class="js-product my-xs">開啟圖片</a></li>
                    <li><a href="#" class="js-search my-xs">訂單查詢</a></li>
                    <li><a href="#" class="js-edit my-xs">訂單修改</a></li>
                </ul>
            </div>
        </div>


        <div class="row jy-content-center">
            <div class="col-md-8">
                <div class="search py-s px-s">
                    <p class="text-c-primary f-size-m f-w-600 text-center mb-s">訂單查詢</p>
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label for="search_name">訂購人 ( Line暱稱為主 )</label>
                            <input type="text" name="search_name" id="search_name" placeholder="請填入訂購人名子">
                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label for="search_phon">電話</label>
                            <input type="tel" name="search_phon" id="search_phone" placeholder="請填入訂購單的聯絡電話">
                        </div>
                    </div>
                    <div class="btn-group">
                        <div class="row jy-content-end">
                            <div class="col-sm-4 btn-control my-xxs">
                                <div class="btn btn-secondary py-s js-search-send">查詢</div>
                            </div>
                            <div class="col-sm-4 btn-control my-xxs">
                                <div class="btn btn-secondary py-s js-search-close">取消</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row jy-content-center">
            <div class="col-md-8">
                <div class="edit py-s px-s">
                    <p class="text-c-primary f-size-m f-w-600 text-center mb-s">訂單修改</p>
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label for="edit_name">訂購人 ( Line暱稱為主 )</label>
                            <input type="text" name="edit_name" id="edit_name" placeholder="請填入訂購人名子">
                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="form-group">
                            <label for="edit_phon">電話</label>
                            <input type="tel" name="edit_phon" id="edit_phone" placeholder="請填入訂購單的聯絡電話">
                        </div>
                    </div>
                    <div class="btn-group">
                        <div class="row jy-content-end">
                            <div class="col-sm-4 btn-control my-xxs">
                                <div class="btn btn-secondary py-s js-edit-send">送出</div>
                            </div>
                            <div class="col-sm-4 btn-control my-xxs">
                                <div class="btn btn-secondary py-s js-edit-close">取消</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <div class="col-12 product">
                <div class="product-close">
                    <i class="fas fa-times text-c-secondary js-product-close"></i>
                </div>
            </div>
            <div class="product-list">
                <div class="row">
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/I9GK3jY.jpg);">
                    </div>
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/FZMeXXy.jpg);">
                    </div>
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/VdM37Ue.jpg);">
                    </div>
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/TVNXhvJ.jpg);">
                    </div>
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/pSU19kx.jpg);">
                    </div>
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/eOeCPzK.jpg);">
                    </div>
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/OsA7H8C.jpg);">
                    </div>
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/pSU19kx.jpg);">
                    </div>
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/v8WMBDD.jpg);">
                    </div>
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/v4p0F7j.jpg);">
                    </div>
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/dgliTOm.jpg);">
                    </div>
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/0U3FRNR.jpg);">
                    </div>
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/iczukWJ.jpg);">
                    </div>
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/PIz5RvF.jpg);">
                    </div>
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/aw4ymGV.jpg);">
                    </div>
                    <div class="col-md-6 product-img" style="background-image: url(https://i.imgur.com/BKfJklV.jpg);">
                    </div>
                </div>
            </div>
        </div>

        <div class="row jy-content-center">
            <div class="col-md-8">
                <div class="b-order p-relative">
                    <div class="js-loading p-absolute"><img src="./img/loading.gif" alt="" width="150px" height="150px">
                    </div>
                    <div class="listInfo my-s "></div>
                    <form action="#">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <label for="name">訂購人 ( Line暱稱為主 )</label>
                                    <input type="text" name="name" id="name" placeholder="Amily">
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <label for="date">訂購日期</label>
                                    <input type="text" name="date" id="date" placeholder="05/19">
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <label for="time">期望送達時間</label>
                                    <input type="text" name="time" id="time" placeholder="10:00 or 18:00">
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <label for="phone">連絡電話</label>
                                    <input type="tel" name="phone" id="phone" placeholder="09xx-xxx-xxx">
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <label for="address">送達地址</label>
                                    <input type="text" name="address" id="address" placeholder="目前只接 大安 信義區">
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <label for="list">訂購清單</label>
                                    <textarea name="list" id="list" rows="10"></textarea>
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="form-group">
                                    <label for="ps">備註</label>
                                    <input type="text" name="ps" id="ps" placeholder="ex: 不接觸取貨 or 送貨前手機通知">
                                    <input class="listNo-value" type="text" id="no" style="display: none;">
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="btn btn-secondary mt-s py-s js-list-send">送出訂單</div>
                                <div class="btn btn-secondary mt-s py-s text-center js-list-edit">修改訂單</div>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="//code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
        crossorigin="anonymous"></script>
    <script>
        let dateInfo = document.querySelector('#date');
        let time = document.querySelector('#time');
        let nameInfo = document.querySelector('#name');
        let phone = document.querySelector('#phone');
        let address = document.querySelector('#address');
        let list = document.querySelector('#list');
        let ps = document.querySelector('#ps');
        let infoListEmpty = [dateInfo, time, nameInfo, phone, address, ps, list];



        let btn = document.querySelector('.js-list-send');
        let listEditbtn = document.querySelector('.js-list-edit');
        let orderBtn = document.querySelector('.js-order');
        let productBtn = document.querySelector('.js-product');
        let loading = document.querySelector('.js-loading');
        let form = document.querySelector('form');
        let orderList = document.querySelector('.b-order');
        let product = document.querySelector('.product-list');
        let productCloseBtn = document.querySelector('.js-product-close');
        let productCloseBlock = document.querySelector('.product-close');
        let search = document.querySelector('.search');
        let edit = document.querySelector('.edit');
        let productBtnFlag = false;
        let searchBtnFlag = false;
        let editBtnFlag = false;
        let listNo = '';
        let searchBtn = document.querySelector('.js-search');
        let searchCloseBtn = document.querySelector('.js-search-close');
        let searchSendBtn = document.querySelector('.js-search-send');
        let editBtn = document.querySelector('.js-edit');
        let editCloseBtn = document.querySelector('.js-edit-close');
        let editSendBtn = document.querySelector('.js-edit-send');
        let listInfoHtml = document.querySelector('.listInfo');

        btn.addEventListener('click', sendList);
        orderBtn.addEventListener('click', orderListControl);
        productBtn.addEventListener('click', productHandler);
        productCloseBtn.addEventListener('click', productHandler);
        searchBtn.addEventListener('click', searchHandler);
        searchCloseBtn.addEventListener('click', searchHandler);
        searchSendBtn.addEventListener('click', getListInfo);
        editBtn.addEventListener('click', editHandler);
        editCloseBtn.addEventListener('click', editHandler);
        editSendBtn.addEventListener('click', getListInfo);
        listEditbtn.addEventListener('click', editList);


        function orderListControl(e) {
            let flag;
            e == undefined ? flag = false : flag = true;
            let searchName = document.querySelector('#search_name');
            let searchPhone = document.querySelector('#search_phone');
            if (flag === true) {
                console.log(1);
                if(searchBtnFlag === true){
                    searchBtnFlag = !searchBtnFlag
                    checkProduct(searchBtnFlag, 'search');
                }else if(editBtnFlag === true){
                    editBtnFlag = !editBtnFlag;
                    checkProduct(searchBtnFlag, 'edit');
                }
                listInfoHtml.style = 'display: none';
                listInfoHtml.innerHTML = '';
                form.style = 'display: block';
            } else {
                listInfoHtml.style = 'display: block';
                searchName.value = '';
                searchPhone.value = '';
                form.style = 'display: none';
            }
        }


        function getListInfo(e) {
            clickNode = e.target.innerText;
            let searchName = document.querySelector('#search_name');
            let searchPhone = document.querySelector('#search_phone');
            let editName = document.querySelector('#edit_name');
            let editPhone = document.querySelector('#edit_phone');
            let ApiUrl = 'https://script.google.com/macros/s/AKfycbzpur_MtR85k5FPDcHF18U5XHRmHkm0xNOLQA4DQR7ioSTjf7M/exec';
            let searchListInfo = [searchName, searchPhone];
            let editListInfo = [editName, editPhone];
            let data;
            if (clickNode == "查詢" ? checkList(searchListInfo) : false) {
                searchBtnFlag = !searchBtnFlag;
                checkProduct(searchBtnFlag, 'search');
                loadingHandler(true);
                $.ajax({
                    type: "Get",
                    url: ApiUrl,
                    data: {
                        "order_name": searchName.value,
                        "order_phone": searchPhone.value
                    },
                    success: function (res) {
                        console.log(res);
                        if(res.length == 0){alert('查無此訂單'); loadingHandler(false); return}
                        data = res[0].data;
                        lastIndex = data.length - 1;
                        orderListControl();
                        inneHtmlListInfo(data);
                        loadingHandler(false);
                    },

                });
            } else if (clickNode == "送出" ? checkList(editListInfo) : false) {
                editBtnFlag = !editBtnFlag;
                checkProduct(editBtnFlag, 'edit');
                loadingHandler(true);
                $.ajax({
                    type: "Get",
                    url: ApiUrl,
                    data: {
                        "order_name": editName.value,
                        "order_phone": editPhone.value
                    },
                    success: function (res) {
                        console.log(res);
                        if(res.length == 0){alert('查無此訂單'); loadingHandler(false); return}
                        editName.value = '';
                        editPhone.value = '';
                        data = res[0].data;
                        console.log(data);
                        lastIndex = data.length - 1;
                        listNo = data[lastIndex - 2];
                        console.log(listNo);
                        if (data[lastIndex] == '已送出') {
                            alert('訂單已送出 請重新訂購');
                            loadingHandler(false);
                        } else {
                            btn.style = 'display: none';
                            listEditbtn.style = 'display: block';
                            document.querySelector('.listNo-value').value = listNo;
                            infoListEmpty.forEach((item, index) => {
                                console.log(item, data[index])
                                item.value = data[index];
                            })
                            loadingHandler(false);
                        }
                    },
                })
            }
        }


        function inneHtmlListInfo(data) {
            let listInfo = document.querySelector('.listInfo');
            let productList;
            let productStr1 = '';
            let productStr2 = '';
            productList = data[6].split(/[ \n]/);

            productList.forEach((item, index) => {
                if (index % 2 == 0) {
                    item !== '' ? productStr1 = productStr1 + `${item} <br>` : 0;
                } else {
                    item !== '' ? productStr2 = productStr2 + `${item} <br>` : 0;
                }
            })

            let str = `
                        <p class="text-c-thirdary f-size-l f-w-bold text-center mb-m">訂單狀態</p>
                        <div class="listInfo-name d-flex jy-content-center">
                            <p class="text-c-primary f-size-m f-w-600 mx-xs">訂購人</p>
                            <p class="text-c-primary f-size-m f-w-600 mx-xs">${data[2]}</p>
                        </div>
                        <div class="listInfo-list my-s">
                            <p class="text-c-primary f-size-m f-w-600 text-center my-xxs">訂單內容</p>
                            <div class="listInfo-list-product d-flex jy-content-center bg-thirdary p-s">
                                <p class="text-c-primary f-size-s f-w-600 text-center mx-xs">${productStr1}</p>
                                <p class="text-c-primary f-size-s f-w-600 text-center mx-xs">${productStr2}</p>
                            </div>
                        </div>
                        <div class="listInfo-total d-flex jy-content-around">
                            <p class="text-c-white f-size-l f-w-bold ">總金額</p>
                            <p class="text-c-white f-size-l f-w-bold ">${data[data.length - 2] !== '' ? data[data.length - 2] : '訂單未結算'}</p>                            
                        </div>
                        <div class="listInfo-sendStatus my-m">
                            <p class="text-c-white f-size-l f-w-bold text-center" style="color: red">${data[data.length - 1] !== '' ? data[data.length - 1] : '未送出'}</p>                       
                        </div>
            `
            listInfo.innerHTML = str;
        }


        function editHandler(e) {
            if (e.target.innerText === '取消') {
                editBtnFlag = false;
                checkProduct(editBtnFlag, 'edit');
            } else {
                editBtnFlag = !editBtnFlag;
                checkProduct(editBtnFlag, 'edit');
            }
        }


        function searchHandler(e) {
            if (e.target.innerText === '取消') {
                searchBtnFlag = false;
                checkProduct(searchBtnFlag, 'search');
            } else {
                searchBtnFlag = !searchBtnFlag;
                checkProduct(searchBtnFlag, 'search');
            }
        }

        function productHandler(e) {
            if (e.target.nodeName == 'I') {
                productBtnFlag = false;
                checkProduct(productBtnFlag, 'product');
            } else {
                productBtnFlag = !productBtnFlag;
                checkProduct(productBtnFlag, 'product');
            }
        }

        function editList(){
            let date = document.querySelector('#date');
            let time = document.querySelector('#time');
            let name = document.querySelector('#name');
            let phone = document.querySelector('#phone');
            let address = document.querySelector('#address');
            let list = document.querySelector('#list');
            let ps = document.querySelector('#ps');
            let listNo = document.querySelector('.listNo-value');
            let checkData = [date, time, name, address, list];
            if (checkList(checkData)) {
                loadingHandler(true);
                $.ajax({
                    type: "post",
                    url: "https://script.google.com/macros/s/AKfycbztKxtM7tXTkr7kgxvPOVkp7WzT85aIwukg7FZ4BhZ4p2vUKVTi/exec",
                    data: {
                        "order_date": date.value,
                        "order_time": time.value,
                        "order_name": name.value,
                        "order_phone": phone.value + '',
                        "order_address": address.value,
                        "order_ps": ps.value,
                        "order_list": list.value,
                        "order_no": listNo.value
                    },
                    success: function (response) {
                        if (response == "成功") {
                            date.value = "";
                            time.value = "";
                            name.value = "";
                            phone.value = "";
                            address.value = "";
                            ps.value = "";
                            list.value = "";
                            listNo.value = "";
                            btn.style = 'display: none';
                            listEditbtn.style = 'display: block';
                            loadingHandler(false);
                            alert('修改成功');
                        }
                    }
                });
            }

        }


        function sendList() {
            let date = document.querySelector('#date');
            let time = document.querySelector('#time');
            let name = document.querySelector('#name');
            let phone = document.querySelector('#phone');
            let address = document.querySelector('#address');
            let list = document.querySelector('#list');
            let ps = document.querySelector('#ps');
            let checkData = [date, time, name, address, list];
            if (checkList(checkData)) {
                loadingHandler(true);
                $.ajax({
                    type: "post",
                    url: "https://script.google.com/macros/s/AKfycbzpur_MtR85k5FPDcHF18U5XHRmHkm0xNOLQA4DQR7ioSTjf7M/exec",
                    data: {
                        "order_date": date.value,
                        "order_time": time.value,
                        "order_name": name.value,
                        "order_phone": phone.value + '',
                        "order_address": address.value,
                        "order_ps": ps.value,
                        "order_list": list.value,
                    },
                    success: function (response) {
                        if (response == "成功") {
                            date.value = "";
                            time.value = "";
                            name.value = "";
                            phone.value = "";
                            address.value = "";
                            ps.value = "";
                            list.value = "";
                            loadingHandler(false);
                            alert('訂購成功');
                        }
                    }
                });
            }
        }
        function loadingHandler(flag) {
            if (flag == true) {
                loading.classList.add('loading');
                form.classList.add('loading')
            } else {
                loading.classList.remove('loading');
                form.classList.remove('loading')
            }
        }

        function checkList(data) {
            let flag = 0;
            data.forEach(item => {
                if (item.value !== '') {
                    console.log("flag:" + flag);
                    flag++;
                    item.classList.remove('danger')
                } else {
                    item.classList.add('danger')
                }
            })
            if (flag == data.length) {
                return true
            } else {
                console.log(flag);
                alert(`請將必填選項填入`);
                return false
            }

        }

        function checkProduct(flag, type) {
            if (type == 'search') {
                if (flag === true) {
                    if(editBtnFlag === true){
                        edit.classList.remove('active');
                        editBtnFlag = !editBtnFlag;
                    }
                    search.classList.add('active');
                    orderList.classList.add('active');
                } else {
                    search.classList.remove('active');
                    orderList.classList.remove('active');
                }

            } else if (type == 'edit') {
                if (flag === true) {
                    if(searchBtnFlag === true){
                        search.classList.remove('active');
                        searchBtnFlag = !searchBtnFlag;
                    }
                    edit.classList.add('active');
                    orderList.classList.add('active');
                } else {
                    edit.classList.remove('active');
                    orderList.classList.remove('active');
                }
            } else {
                if (flag === true) {
                    productBtn.text = '關閉圖片';
                    product.classList.add('active');
                    orderList.classList.add('active');
                    setTimeout(function () { productCloseBlock.style = "display: block" }, 500);
                } else {
                    productCloseBlock.style = "display: none";
                    productBtn.text = '開啟圖片';
                    product.classList.remove('active');
                    orderList.classList.remove('active');
                }
            }
        }
    </script>

</body>

</html>